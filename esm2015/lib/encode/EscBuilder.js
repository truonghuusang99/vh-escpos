// import { PrintBuilder } from './PrintBuilder';
import { PrintBuffer } from './PrintBuffer';
import _, { RasterMode } from './commands';
import { styles } from './styles';
const ESC = 0x1b;
const GS = 0x1d;
export class EscBuilder {
    constructor() {
        this.encoder = new TextEncoder();
        this.size = 48;
    }
    init() {
        this.buffer = new PrintBuffer();
        this.write(ESC);
        this.write('@');
        return this;
    }
    flush() {
        return this.buffer.flush();
    }
    feed(lineCount = 1) {
        this.write(ESC);
        this.write('d');
        this.write(lineCount);
        return this;
    }
    cut(cutType = 'full') {
        this.write(GS);
        this.write('V');
        this.write(cutType === 'full' ? 1 : 0);
        return this;
    }
    writeLine(value) {
        return this.write(`${value}\n`);
    }
    drawLine() {
        let lineText = '';
        for (let i = 0; i < this.size; i++) {
            lineText += '-';
        }
        return this.write(`${lineText}\n`);
    }
    setPageSize(size) {
        this.size = size;
        return this;
    }
    writeTable(data) {
        let cellWidth = this.size / data.length;
        let lineTxt = '';
        for (let i = 0; i < data.length; i++) {
            lineTxt += data[i].toString();
            let spaces = cellWidth - data[i].toString().length;
            for (let j = 0; j < spaces; j++) {
                lineTxt += ' ';
            }
        }
        return this.write(`${lineTxt}\n`);
    }
    writeCustomTable(data, options) {
        options = options || { size: [] };
        options.size = options.size || [];
        let [width = 1, height = 1] = options.size || [];
        let baseWidth = Math.floor(this.size / width);
        let cellWidth = Math.floor(baseWidth / data.length);
        let leftoverSpace = baseWidth - cellWidth * data.length;
        let lineStr = '';
        let secondLineEnabled = false;
        let secondLine = [];
        for (let i = 0; i < data.length; i++) {
            let obj = data[i];
            let align = (obj.align || '').toUpperCase();
            let tooLong = false;
            obj.text = obj.text.toString();
            let textLength = obj.text.length;
            if (obj.width) {
                cellWidth = baseWidth * obj.width;
            }
            else if (obj.cols) {
                cellWidth = obj.cols;
            }
            if (cellWidth < textLength) {
                tooLong = true;
                obj.originalText = obj.text;
                obj.text = obj.text.substring(0, cellWidth);
            }
            if (align === 'CENTER') {
                let spaces = (cellWidth - textLength) / 2;
                for (let s = 0; s < spaces; s++) {
                    lineStr += ' ';
                }
                if (obj.text !== '') {
                    if (obj.style) {
                        lineStr +=
                            styles(obj.style) + obj.text + styles('NORMAL');
                    }
                    else {
                        lineStr += obj.text;
                    }
                }
                for (let s = 0; s < spaces - 1; s++) {
                    lineStr += ' ';
                }
            }
            else if (align === 'RIGHT') {
                let spaces = cellWidth - textLength;
                if (leftoverSpace > 0) {
                    spaces += leftoverSpace;
                    leftoverSpace = 0;
                }
                for (let s = 0; s < spaces; s++) {
                    lineStr += ' ';
                }
                if (obj.text !== '') {
                    if (obj.style) {
                        lineStr +=
                            styles(obj.style) + obj.text + styles('NORMAL');
                    }
                    else {
                        lineStr += obj.text;
                    }
                }
            }
            else {
                if (obj.text !== '') {
                    if (obj.style) {
                        lineStr +=
                            styles(obj.style) + obj.text + styles('NORMAL');
                    }
                    else {
                        lineStr += obj.text;
                    }
                }
                let spaces = Math.floor(cellWidth - textLength);
                if (leftoverSpace > 0) {
                    spaces += leftoverSpace;
                    leftoverSpace = 0;
                }
                for (let s = 0; s < spaces; s++) {
                    lineStr += ' ';
                }
            }
            if (tooLong) {
                secondLineEnabled = true;
                obj.text = obj.originalText.substring(cellWidth);
                secondLine.push(obj);
            }
            else {
                obj.text = '';
                secondLine.push(obj);
            }
        }
        // Set size to line
        if (width > 1) {
            lineStr =
                _.TEXT_FORMAT.TXT_CUSTOM_SIZE(width, height) +
                    lineStr +
                    _.TEXT_FORMAT.TXT_NORMAL;
        }
        // Write the line
        this.write(`${lineStr}\n`);
        if (secondLineEnabled) {
            // Writes second line if has
            return this.writeCustomTable(secondLine, options);
        }
        else {
            if (options.feed) {
                this.feed(options.feed);
            }
            if (options.drawLine) {
                this.drawLine();
            }
            return this;
        }
    }
    setInverse(inverse = true) {
        this.write(GS);
        this.write('B');
        this.write(inverse ? 1 : 0);
        return this;
    }
    setUnderline(value = true) {
        this.write(ESC);
        this.write('-');
        this.write(value ? 1 : 0);
        return this;
    }
    setJustification(value = 'left') {
        let alignment;
        switch (value) {
            case 'center':
                alignment = 1;
                break;
            case 'right':
                alignment = 2;
                break;
            default:
                alignment = 0;
                break;
        }
        this.write(ESC);
        this.write('a');
        this.write(alignment);
        return this;
    }
    setBold(bold = true) {
        this.write(ESC);
        this.write('E');
        this.write(bold ? 1 : 0);
        return this;
    }
    raster(image, mode = RasterMode.Normal) {
        const header = new Uint8Array([GS, 0x76, 0x30, mode]);
        const raster = image.toRaster();
        this.write(header);
        this.write(raster.width, 16);
        this.write(raster.height, 16);
        this.write(raster.data);
        return this;
    }
    /**
    @param mode 0, 0x30
    */
    setSize(size = 'normal') {
        this.write(ESC);
        this.write('!');
        this.write(size === 'normal' ? 0 : 0x30);
        return this;
    }
    write(value, number = 8) {
        if (typeof value === 'number') {
            if (number == 8)
                this.buffer.writeUInt8(value);
            if (number == 16)
                this.buffer.writeUInt16LE(value);
            if (number == 32)
                this.buffer.writeUInt32LE(value);
        }
        else if (typeof value === 'string') {
            this.buffer.write(this.encoder.encode(value));
        }
        else {
            this.buffer.write(value);
        }
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXNjQnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3ZoLWVzY3Bvcy9zcmMvbGliL2VuY29kZS9Fc2NCdWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVDLE9BQU8sQ0FBQyxFQUFFLEVBQWMsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRXZELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFHbEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztBQUVoQixNQUFNLE9BQU8sVUFBVTtJQUluQjtRQUhRLFlBQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBSWhDLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJO1FBQ0EsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsS0FBSztRQUNELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBSSxDQUFDLFlBQW9CLENBQUM7UUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdEIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELEdBQUcsQ0FBQyxV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SyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFekMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxLQUFtQyxFQUFFLFNBQWlCLENBQUM7UUFDakUsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDM0IsSUFBSSxNQUFNLElBQUksQ0FBQztnQkFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQyxJQUFJLE1BQU0sSUFBSSxFQUFFO2dCQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25ELElBQUksTUFBTSxJQUFJLEVBQUU7Z0JBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdEQ7YUFBTSxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUNsQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ2pEO2FBQU07WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM1QjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8vIGltcG9ydCB7IFByaW50QnVpbGRlciB9IGZyb20gJy4vUHJpbnRCdWlsZGVyJztcbmltcG9ydCB7IFByaW50QnVmZmVyIH0gZnJvbSAnLi9QcmludEJ1ZmZlcic7XG5pbXBvcnQgXywgeyBQREY0MTdUeXBlLCBSYXN0ZXJNb2RlIH0gZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgeyBJbWFnZSB9IGZyb20gXCIuL0ltYWdlXCI7XG5pbXBvcnQgeyBzdHlsZXMgfSBmcm9tICcuL3N0eWxlcyc7XG5cbmRlY2xhcmUgdmFyIFRleHRFbmNvZGVyOiBhbnk7XG5jb25zdCBFU0MgPSAweDFiO1xuY29uc3QgR1MgPSAweDFkO1xuXG5leHBvcnQgY2xhc3MgRXNjQnVpbGRlciB7XG4gICAgcHJpdmF0ZSBlbmNvZGVyID0gbmV3IFRleHRFbmNvZGVyKCk7XG4gICAgcHJpdmF0ZSBidWZmZXI6IFByaW50QnVmZmVyO1xuICAgIHByaXZhdGUgc2l6ZTogbnVtYmVyO1xuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICB0aGlzLnNpemUgPSA0ODtcbiAgICB9XG5cbiAgICBpbml0KCk6IEVzY0J1aWxkZXIge1xuICAgICAgICB0aGlzLmJ1ZmZlciA9IG5ldyBQcmludEJ1ZmZlcigpO1xuICAgICAgICB0aGlzLndyaXRlKEVTQyk7XG4gICAgICAgIHRoaXMud3JpdGUoJ0AnKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgZmx1c2goKTogVWludDhBcnJheSB7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlci5mbHVzaCgpO1xuICAgIH1cblxuICAgIGZlZWQobGluZUNvdW50OiBudW1iZXIgPSAxKTogRXNjQnVpbGRlciB7XG4gICAgICAgIHRoaXMud3JpdGUoRVNDKTtcbiAgICAgICAgdGhpcy53cml0ZSgnZCcpO1xuICAgICAgICB0aGlzLndyaXRlKGxpbmVDb3VudCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGN1dChjdXRUeXBlOiBzdHJpbmcgPSAnZnVsbCcpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgdGhpcy53cml0ZShHUyk7XG4gICAgICAgIHRoaXMud3JpdGUoJ1YnKTtcbiAgICAgICAgdGhpcy53cml0ZShjdXRUeXBlID09PSAnZnVsbCcgPyAxIDogMCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgd3JpdGVMaW5lKHZhbHVlOiBzdHJpbmcpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMud3JpdGUoYCR7dmFsdWV9XFxuYCk7XG4gICAgfVxuXG4gICAgZHJhd0xpbmUoKTogRXNjQnVpbGRlciB7XG4gICAgICAgIGxldCBsaW5lVGV4dCA9ICcnO1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2l6ZTsgaSsrKSB7XG4gICAgICAgICAgICBsaW5lVGV4dCArPSAnLSc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMud3JpdGUoYCR7bGluZVRleHR9XFxuYCk7XG4gICAgfVxuXG4gICAgc2V0UGFnZVNpemUoc2l6ZTogbnVtYmVyKTogRXNjQnVpbGRlciB7XG4gICAgICAgIHRoaXMuc2l6ZSA9IHNpemU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHdyaXRlVGFibGUoZGF0YTogYW55KTogRXNjQnVpbGRlciB7XG4gICAgICAgIGxldCBjZWxsV2lkdGggPSB0aGlzLnNpemUgLyBkYXRhLmxlbmd0aDtcbiAgICAgICAgbGV0IGxpbmVUeHQgPSAnJztcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGxpbmVUeHQgKz0gZGF0YVtpXS50b1N0cmluZygpO1xuXG4gICAgICAgICAgICBsZXQgc3BhY2VzID0gY2VsbFdpZHRoIC0gZGF0YVtpXS50b1N0cmluZygpLmxlbmd0aDtcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgc3BhY2VzOyBqKyspIHtcbiAgICAgICAgICAgICAgICBsaW5lVHh0ICs9ICcgJztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy53cml0ZShgJHtsaW5lVHh0fVxcbmApO1xuICAgIH1cblxuICAgIHdyaXRlQ3VzdG9tVGFibGUoZGF0YTogYW55LCBvcHRpb25zOiBhbnkpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwgeyBzaXplOiBbXSB9O1xuICAgICAgICBvcHRpb25zLnNpemUgPSBvcHRpb25zLnNpemUgfHwgW107XG4gICAgICAgIGxldCBbd2lkdGggPSAxLCBoZWlnaHQgPSAxXSA9IG9wdGlvbnMuc2l6ZSB8fCBbXTtcbiAgICAgICAgbGV0IGJhc2VXaWR0aCA9IE1hdGguZmxvb3IodGhpcy5zaXplIC8gd2lkdGgpO1xuICAgICAgICBsZXQgY2VsbFdpZHRoID0gTWF0aC5mbG9vcihiYXNlV2lkdGggLyBkYXRhLmxlbmd0aCk7XG4gICAgICAgIGxldCBsZWZ0b3ZlclNwYWNlID0gYmFzZVdpZHRoIC0gY2VsbFdpZHRoICogZGF0YS5sZW5ndGg7XG4gICAgICAgIGxldCBsaW5lU3RyID0gJyc7XG4gICAgICAgIGxldCBzZWNvbmRMaW5lRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICBsZXQgc2Vjb25kTGluZSA9IFtdO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGV0IG9iaiA9IGRhdGFbaV07XG4gICAgICAgICAgICBsZXQgYWxpZ24gPSAob2JqLmFsaWduIHx8ICcnKS50b1VwcGVyQ2FzZSgpO1xuICAgICAgICAgICAgbGV0IHRvb0xvbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgb2JqLnRleHQgPSBvYmoudGV4dC50b1N0cmluZygpO1xuICAgICAgICAgICAgbGV0IHRleHRMZW5ndGggPSBvYmoudGV4dC5sZW5ndGg7XG5cbiAgICAgICAgICAgIGlmIChvYmoud2lkdGgpIHtcbiAgICAgICAgICAgICAgICBjZWxsV2lkdGggPSBiYXNlV2lkdGggKiBvYmoud2lkdGg7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9iai5jb2xzKSB7XG4gICAgICAgICAgICAgICAgY2VsbFdpZHRoID0gb2JqLmNvbHM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjZWxsV2lkdGggPCB0ZXh0TGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgdG9vTG9uZyA9IHRydWU7XG4gICAgICAgICAgICAgICAgb2JqLm9yaWdpbmFsVGV4dCA9IG9iai50ZXh0O1xuICAgICAgICAgICAgICAgIG9iai50ZXh0ID0gb2JqLnRleHQuc3Vic3RyaW5nKDAsIGNlbGxXaWR0aCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhbGlnbiA9PT0gJ0NFTlRFUicpIHtcbiAgICAgICAgICAgICAgICBsZXQgc3BhY2VzID0gKGNlbGxXaWR0aCAtIHRleHRMZW5ndGgpIC8gMjtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBzID0gMDsgcyA8IHNwYWNlczsgcysrKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVTdHIgKz0gJyAnO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChvYmoudGV4dCAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5zdHlsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlcyhvYmouc3R5bGUpICsgb2JqLnRleHQgKyBzdHlsZXMoJ05PUk1BTCcpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPSBvYmoudGV4dDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3BhY2VzIC0gMTsgcysrKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVTdHIgKz0gJyAnO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYWxpZ24gPT09ICdSSUdIVCcpIHtcbiAgICAgICAgICAgICAgICBsZXQgc3BhY2VzID0gY2VsbFdpZHRoIC0gdGV4dExlbmd0aDtcbiAgICAgICAgICAgICAgICBpZiAobGVmdG92ZXJTcGFjZSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgc3BhY2VzICs9IGxlZnRvdmVyU3BhY2U7XG4gICAgICAgICAgICAgICAgICAgIGxlZnRvdmVyU3BhY2UgPSAwO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3BhY2VzOyBzKyspIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPSAnICc7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKG9iai50ZXh0ICE9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAob2JqLnN0eWxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lU3RyICs9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVzKG9iai5zdHlsZSkgKyBvYmoudGV4dCArIHN0eWxlcygnTk9STUFMJyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lU3RyICs9IG9iai50ZXh0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAob2JqLnRleHQgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvYmouc3R5bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVTdHIgKz1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZXMob2JqLnN0eWxlKSArIG9iai50ZXh0ICsgc3R5bGVzKCdOT1JNQUwnKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVTdHIgKz0gb2JqLnRleHQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBsZXQgc3BhY2VzID0gTWF0aC5mbG9vcihjZWxsV2lkdGggLSB0ZXh0TGVuZ3RoKTtcbiAgICAgICAgICAgICAgICBpZiAobGVmdG92ZXJTcGFjZSA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgc3BhY2VzICs9IGxlZnRvdmVyU3BhY2U7XG4gICAgICAgICAgICAgICAgICAgIGxlZnRvdmVyU3BhY2UgPSAwO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3BhY2VzOyBzKyspIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPSAnICc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodG9vTG9uZykge1xuICAgICAgICAgICAgICAgIHNlY29uZExpbmVFbmFibGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBvYmoudGV4dCA9IG9iai5vcmlnaW5hbFRleHQuc3Vic3RyaW5nKGNlbGxXaWR0aCk7XG4gICAgICAgICAgICAgICAgc2Vjb25kTGluZS5wdXNoKG9iaik7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG9iai50ZXh0ID0gJyc7XG4gICAgICAgICAgICAgICAgc2Vjb25kTGluZS5wdXNoKG9iaik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTZXQgc2l6ZSB0byBsaW5lXG4gICAgICAgIGlmICh3aWR0aCA+IDEpIHtcbiAgICAgICAgICAgIGxpbmVTdHIgPVxuICAgICAgICAgICAgICAgIF8uVEVYVF9GT1JNQVQuVFhUX0NVU1RPTV9TSVpFKHdpZHRoLCBoZWlnaHQpICtcbiAgICAgICAgICAgICAgICBsaW5lU3RyICtcbiAgICAgICAgICAgICAgICBfLlRFWFRfRk9STUFULlRYVF9OT1JNQUw7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBXcml0ZSB0aGUgbGluZVxuICAgICAgICB0aGlzLndyaXRlKGAke2xpbmVTdHJ9XFxuYCk7XG4gICAgICAgIGlmIChzZWNvbmRMaW5lRW5hYmxlZCkge1xuICAgICAgICAgICAgLy8gV3JpdGVzIHNlY29uZCBsaW5lIGlmIGhhc1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMud3JpdGVDdXN0b21UYWJsZShzZWNvbmRMaW5lLCBvcHRpb25zKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmZlZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZlZWQob3B0aW9ucy5mZWVkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvcHRpb25zLmRyYXdMaW5lKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5kcmF3TGluZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZXRJbnZlcnNlKGludmVyc2U6IGJvb2xlYW4gPSB0cnVlKTogRXNjQnVpbGRlciB7XG4gICAgICAgIHRoaXMud3JpdGUoR1MpO1xuICAgICAgICB0aGlzLndyaXRlKCdCJyk7XG4gICAgICAgIHRoaXMud3JpdGUoaW52ZXJzZSA/IDEgOiAwKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzZXRVbmRlcmxpbmUodmFsdWU6IGJvb2xlYW4gPSB0cnVlKTogRXNjQnVpbGRlciB7XG4gICAgICAgIHRoaXMud3JpdGUoRVNDKTtcbiAgICAgICAgdGhpcy53cml0ZSgnLScpO1xuICAgICAgICB0aGlzLndyaXRlKHZhbHVlID8gMSA6IDApO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzZXRKdXN0aWZpY2F0aW9uKHZhbHVlOiBzdHJpbmcgPSAnbGVmdCcpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgbGV0IGFsaWdubWVudDtcbiAgICAgICAgc3dpdGNoICh2YWx1ZSkge1xuICAgICAgICAgICAgY2FzZSAnY2VudGVyJzpcbiAgICAgICAgICAgICAgICBhbGlnbm1lbnQgPSAxO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAncmlnaHQnOlxuICAgICAgICAgICAgICAgIGFsaWdubWVudCA9IDI7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGFsaWdubWVudCA9IDA7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy53cml0ZShFU0MpO1xuICAgICAgICB0aGlzLndyaXRlKCdhJyk7XG4gICAgICAgIHRoaXMud3JpdGUoYWxpZ25tZW50KTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBzZXRCb2xkKGJvbGQ6IGJvb2xlYW4gPSB0cnVlKTogRXNjQnVpbGRlciB7XG4gICAgICAgIHRoaXMud3JpdGUoRVNDKTtcbiAgICAgICAgdGhpcy53cml0ZSgnRScpO1xuICAgICAgICB0aGlzLndyaXRlKGJvbGQgPyAxIDogMCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcmFzdGVyKGltYWdlOiBJbWFnZSwgbW9kZTogUmFzdGVyTW9kZSA9IFJhc3Rlck1vZGUuTm9ybWFsKTogRXNjQnVpbGRlciB7XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IG5ldyBVaW50OEFycmF5KFtHUywgMHg3NiwgMHgzMCwgbW9kZV0pO1xuICAgICAgICBjb25zdCByYXN0ZXIgPSBpbWFnZS50b1Jhc3RlcigpO1xuICAgICAgICB0aGlzLndyaXRlKGhlYWRlcik7XG4gICAgICAgIHRoaXMud3JpdGUocmFzdGVyLndpZHRoLCAxNik7XG4gICAgICAgIHRoaXMud3JpdGUocmFzdGVyLmhlaWdodCwgMTYpO1xuICAgICAgICB0aGlzLndyaXRlKHJhc3Rlci5kYXRhKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG5cbiAgICAvKipcbiAgICBAcGFyYW0gbW9kZSAwLCAweDMwXG4gICAgKi9cbiAgICBzZXRTaXplKHNpemU6IHN0cmluZyA9ICdub3JtYWwnKTogRXNjQnVpbGRlciB7XG4gICAgICAgIHRoaXMud3JpdGUoRVNDKTtcbiAgICAgICAgdGhpcy53cml0ZSgnIScpO1xuICAgICAgICB0aGlzLndyaXRlKHNpemUgPT09ICdub3JtYWwnID8gMCA6IDB4MzApO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHByaXZhdGUgd3JpdGUodmFsdWU6IHN0cmluZyB8IFVpbnQ4QXJyYXkgfCBudW1iZXIsIG51bWJlcjogbnVtYmVyID0gOCk6IGFueSB7XG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICBpZiAobnVtYmVyID09IDgpIHRoaXMuYnVmZmVyLndyaXRlVUludDgodmFsdWUpO1xuICAgICAgICAgICAgaWYgKG51bWJlciA9PSAxNikgdGhpcy5idWZmZXIud3JpdGVVSW50MTZMRSh2YWx1ZSk7XG4gICAgICAgICAgICBpZiAobnVtYmVyID09IDMyKSB0aGlzLmJ1ZmZlci53cml0ZVVJbnQzMkxFKHZhbHVlKTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB0aGlzLmJ1ZmZlci53cml0ZSh0aGlzLmVuY29kZXIuZW5jb2RlKHZhbHVlKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmJ1ZmZlci53cml0ZSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxufVxuIl19