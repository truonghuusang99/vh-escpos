// import { PrintBuilder } from './PrintBuilder';
import { PrintBuffer } from './PrintBuffer';
import _, { RasterMode } from './commands';
import { styles } from './styles';
const ESC = 0x1b;
const GS = 0x1d;
export class EscBuilder {
    constructor() {
        this.encoder = new TextEncoder();
        this.size = 48;
    }
    init() {
        this.buffer = new PrintBuffer();
        this.write(ESC);
        this.write('@');
        return this;
    }
    flush() {
        return this.buffer.flush();
    }
    feed(lineCount = 1) {
        this.write(ESC);
        this.write('d');
        this.write(lineCount);
        return this;
    }
    cut(cutType = 'full') {
        this.write(GS);
        this.write('V');
        this.write(cutType === 'full' ? 1 : 0);
        return this;
    }
    writeLine(value) {
        return this.write(`${value}\n`);
    }
    drawLine() {
        let lineText = '';
        for (let i = 0; i < this.size; i++) {
            lineText += '-';
        }
        return this.write(`${lineText}\n`);
    }
    setPageSize(size) {
        this.size = size;
        return this;
    }
    writeTable(data) {
        let cellWidth = this.size / data.length;
        let lineTxt = '';
        for (let i = 0; i < data.length; i++) {
            lineTxt += data[i].toString();
            let spaces = cellWidth - data[i].toString().length;
            for (let j = 0; j < spaces; j++) {
                lineTxt += ' ';
            }
        }
        return this.write(`${lineTxt}\n`);
    }
    writeCustomTable(data, options) {
        options = options || { size: [] };
        options.size = options.size || [];
        let [width = 1, height = 1] = options.size || [];
        let baseWidth = Math.floor(this.size / width);
        let cellWidth = Math.floor(baseWidth / data.length);
        let leftoverSpace = baseWidth - cellWidth * data.length;
        let lineStr = '';
        let secondLineEnabled = false;
        let secondLine = [];
        for (let i = 0; i < data.length; i++) {
            let obj = data[i];
            let align = (obj.align || '').toUpperCase();
            let tooLong = false;
            obj.text = obj.text.toString();
            let textLength = obj.text.length;
            if (obj.width) {
                cellWidth = baseWidth * obj.width;
            }
            else if (obj.cols) {
                cellWidth = obj.cols;
            }
            if (cellWidth < textLength) {
                tooLong = true;
                obj.originalText = obj.text;
                obj.text = obj.text.substring(0, cellWidth);
            }
            if (align === 'CENTER') {
                let spaces = (cellWidth - textLength) / 2;
                for (let s = 0; s < spaces; s++) {
                    lineStr += ' ';
                }
                if (obj.text !== '') {
                    if (obj.style) {
                        lineStr +=
                            styles(obj.style) + obj.text + styles('NORMAL');
                    }
                    else {
                        lineStr += obj.text;
                    }
                }
                for (let s = 0; s < spaces - 1; s++) {
                    lineStr += ' ';
                }
            }
            else if (align === 'RIGHT') {
                let spaces = cellWidth - textLength;
                if (leftoverSpace > 0) {
                    spaces += leftoverSpace;
                    leftoverSpace = 0;
                }
                for (let s = 0; s < spaces; s++) {
                    lineStr += ' ';
                }
                if (obj.text !== '') {
                    if (obj.style) {
                        lineStr +=
                            styles(obj.style) + obj.text + styles('NORMAL');
                    }
                    else {
                        lineStr += obj.text;
                    }
                }
            }
            else {
                if (obj.text !== '') {
                    if (obj.style) {
                        lineStr +=
                            styles(obj.style) + obj.text + styles('NORMAL');
                    }
                    else {
                        lineStr += obj.text;
                    }
                }
                let spaces = Math.floor(cellWidth - textLength);
                if (leftoverSpace > 0) {
                    spaces += leftoverSpace;
                    leftoverSpace = 0;
                }
                for (let s = 0; s < spaces; s++) {
                    lineStr += ' ';
                }
            }
            if (tooLong) {
                secondLineEnabled = true;
                obj.text = obj.originalText.substring(cellWidth);
                secondLine.push(obj);
            }
            else {
                obj.text = '';
                secondLine.push(obj);
            }
        }
        // Set size to line
        if (width > 1) {
            lineStr =
                _.TEXT_FORMAT.TXT_CUSTOM_SIZE(width, height) +
                    lineStr +
                    _.TEXT_FORMAT.TXT_NORMAL;
        }
        // Write the line
        this.write(`${lineStr}\n`);
        if (secondLineEnabled) {
            // Writes second line if has
            return this.writeCustomTable(secondLine, options);
        }
        else {
            if (options.feed) {
                this.feed(options.feed);
            }
            if (options.drawLine) {
                this.drawLine();
            }
            return this;
        }
    }
    setInverse(inverse = true) {
        this.write(GS);
        this.write('B');
        this.write(inverse ? 1 : 0);
        return this;
    }
    setUnderline(value = true) {
        this.write(ESC);
        this.write('-');
        this.write(value ? 1 : 0);
        return this;
    }
    setJustification(value = 'left') {
        let alignment;
        switch (value) {
            case 'center':
                alignment = 1;
                break;
            case 'right':
                alignment = 2;
                break;
            default:
                alignment = 0;
                break;
        }
        this.write(ESC);
        this.write('a');
        this.write(alignment);
        return this;
    }
    setBold(bold = true) {
        this.write(ESC);
        this.write('E');
        this.write(bold ? 1 : 0);
        return this;
    }
    raster(image, mode = RasterMode.Normal) {
        const header = new Uint8Array([GS, 0x76, 0x30, mode]);
        const raster = image.toRaster();
        this.write(header);
        this.write(raster.width, 16);
        this.write(raster.height, 16);
        this.write(raster.data);
        return this;
    }
    /**
    @param mode 0, 0x30
    */
    setSize(size = 'normal') {
        this.write(ESC);
        this.write('!');
        this.write(size === 'normal' ? 0 : 0x30);
        return this;
    }
    write(value, number = 8) {
        if (typeof value === 'number') {
            if (number == 8)
                this.buffer.writeUInt8(value);
            if (number == 16)
                this.buffer.writeUInt16LE(value);
            if (number == 32)
                this.buffer.writeUInt32LE(value);
        }
        else if (typeof value === 'string') {
            this.buffer.write(this.encoder.encode(value));
        }
        else {
            this.buffer.write(value);
        }
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXNjQnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3ZoLWVzY3Bvcy9zcmMvbGliL2VuY29kZS9Fc2NCdWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLGlEQUFpRDtBQUNqRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVDLE9BQU8sQ0FBQyxFQUFFLEVBQWMsVUFBVSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBRXZELE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFHbEMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztBQUVoQixNQUFNLE9BQU8sVUFBVTtJQUluQjtRQUhRLFlBQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBSWhDLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFFRCxJQUFJO1FBQ0EsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsS0FBSztRQUNELE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBSSxDQUFDLFlBQW9CLENBQUM7UUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdEIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVELEdBQUcsQ0FBQyxV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SyxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFFekMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxLQUFtQyxFQUFFLFNBQWlCLENBQUM7UUFDakUsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUU7WUFDM0IsSUFBSSxNQUFNLElBQUksQ0FBQztnQkFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUMvQyxJQUFJLE1BQU0sSUFBSSxFQUFFO2dCQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ25ELElBQUksTUFBTSxJQUFJLEVBQUU7Z0JBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDdEQ7YUFBTSxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUNsQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1NBQ2pEO2FBQU07WUFDSCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM1QjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbIi8vIGltcG9ydCB7IFByaW50QnVpbGRlciB9IGZyb20gJy4vUHJpbnRCdWlsZGVyJztcbmltcG9ydCB7IFByaW50QnVmZmVyIH0gZnJvbSAnLi9QcmludEJ1ZmZlcic7XG5pbXBvcnQgXywgeyBQREY0MTdUeXBlLCBSYXN0ZXJNb2RlIH0gZnJvbSAnLi9jb21tYW5kcyc7XG5pbXBvcnQgSW1hZ2UgZnJvbSBcIi4vSW1hZ2VcIjtcbmltcG9ydCB7IHN0eWxlcyB9IGZyb20gJy4vc3R5bGVzJztcblxuZGVjbGFyZSB2YXIgVGV4dEVuY29kZXI6IGFueTtcbmNvbnN0IEVTQyA9IDB4MWI7XG5jb25zdCBHUyA9IDB4MWQ7XG5cbmV4cG9ydCBjbGFzcyBFc2NCdWlsZGVyIHtcbiAgICBwcml2YXRlIGVuY29kZXIgPSBuZXcgVGV4dEVuY29kZXIoKTtcbiAgICBwcml2YXRlIGJ1ZmZlcjogUHJpbnRCdWZmZXI7XG4gICAgcHJpdmF0ZSBzaXplOiBudW1iZXI7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHRoaXMuc2l6ZSA9IDQ4O1xuICAgIH1cblxuICAgIGluaXQoKTogRXNjQnVpbGRlciB7XG4gICAgICAgIHRoaXMuYnVmZmVyID0gbmV3IFByaW50QnVmZmVyKCk7XG4gICAgICAgIHRoaXMud3JpdGUoRVNDKTtcbiAgICAgICAgdGhpcy53cml0ZSgnQCcpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBmbHVzaCgpOiBVaW50OEFycmF5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyLmZsdXNoKCk7XG4gICAgfVxuXG4gICAgZmVlZChsaW5lQ291bnQ6IG51bWJlciA9IDEpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgdGhpcy53cml0ZShFU0MpO1xuICAgICAgICB0aGlzLndyaXRlKCdkJyk7XG4gICAgICAgIHRoaXMud3JpdGUobGluZUNvdW50KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgY3V0KGN1dFR5cGU6IHN0cmluZyA9ICdmdWxsJyk6IEVzY0J1aWxkZXIge1xuICAgICAgICB0aGlzLndyaXRlKEdTKTtcbiAgICAgICAgdGhpcy53cml0ZSgnVicpO1xuICAgICAgICB0aGlzLndyaXRlKGN1dFR5cGUgPT09ICdmdWxsJyA/IDEgOiAwKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB3cml0ZUxpbmUodmFsdWU6IHN0cmluZyk6IEVzY0J1aWxkZXIge1xuICAgICAgICByZXR1cm4gdGhpcy53cml0ZShgJHt2YWx1ZX1cXG5gKTtcbiAgICB9XG5cbiAgICBkcmF3TGluZSgpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgbGV0IGxpbmVUZXh0ID0gJyc7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zaXplOyBpKyspIHtcbiAgICAgICAgICAgIGxpbmVUZXh0ICs9ICctJztcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcy53cml0ZShgJHtsaW5lVGV4dH1cXG5gKTtcbiAgICB9XG5cbiAgICBzZXRQYWdlU2l6ZShzaXplOiBudW1iZXIpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgdGhpcy5zaXplID0gc2l6ZTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgd3JpdGVUYWJsZShkYXRhOiBhbnkpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgbGV0IGNlbGxXaWR0aCA9IHRoaXMuc2l6ZSAvIGRhdGEubGVuZ3RoO1xuICAgICAgICBsZXQgbGluZVR4dCA9ICcnO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgbGluZVR4dCArPSBkYXRhW2ldLnRvU3RyaW5nKCk7XG5cbiAgICAgICAgICAgIGxldCBzcGFjZXMgPSBjZWxsV2lkdGggLSBkYXRhW2ldLnRvU3RyaW5nKCkubGVuZ3RoO1xuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBzcGFjZXM7IGorKykge1xuICAgICAgICAgICAgICAgIGxpbmVUeHQgKz0gJyAnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLndyaXRlKGAke2xpbmVUeHR9XFxuYCk7XG4gICAgfVxuXG4gICAgd3JpdGVDdXN0b21UYWJsZShkYXRhOiBhbnksIG9wdGlvbnM6IGFueSk6IEVzY0J1aWxkZXIge1xuICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7IHNpemU6IFtdIH07XG4gICAgICAgIG9wdGlvbnMuc2l6ZSA9IG9wdGlvbnMuc2l6ZSB8fCBbXTtcbiAgICAgICAgbGV0IFt3aWR0aCA9IDEsIGhlaWdodCA9IDFdID0gb3B0aW9ucy5zaXplIHx8IFtdO1xuICAgICAgICBsZXQgYmFzZVdpZHRoID0gTWF0aC5mbG9vcih0aGlzLnNpemUgLyB3aWR0aCk7XG4gICAgICAgIGxldCBjZWxsV2lkdGggPSBNYXRoLmZsb29yKGJhc2VXaWR0aCAvIGRhdGEubGVuZ3RoKTtcbiAgICAgICAgbGV0IGxlZnRvdmVyU3BhY2UgPSBiYXNlV2lkdGggLSBjZWxsV2lkdGggKiBkYXRhLmxlbmd0aDtcbiAgICAgICAgbGV0IGxpbmVTdHIgPSAnJztcbiAgICAgICAgbGV0IHNlY29uZExpbmVFbmFibGVkID0gZmFsc2U7XG4gICAgICAgIGxldCBzZWNvbmRMaW5lID0gW107XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBsZXQgb2JqID0gZGF0YVtpXTtcbiAgICAgICAgICAgIGxldCBhbGlnbiA9IChvYmouYWxpZ24gfHwgJycpLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgICAgICBsZXQgdG9vTG9uZyA9IGZhbHNlO1xuXG4gICAgICAgICAgICBvYmoudGV4dCA9IG9iai50ZXh0LnRvU3RyaW5nKCk7XG4gICAgICAgICAgICBsZXQgdGV4dExlbmd0aCA9IG9iai50ZXh0Lmxlbmd0aDtcblxuICAgICAgICAgICAgaWYgKG9iai53aWR0aCkge1xuICAgICAgICAgICAgICAgIGNlbGxXaWR0aCA9IGJhc2VXaWR0aCAqIG9iai53aWR0aDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAob2JqLmNvbHMpIHtcbiAgICAgICAgICAgICAgICBjZWxsV2lkdGggPSBvYmouY29scztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNlbGxXaWR0aCA8IHRleHRMZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0b29Mb25nID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBvYmoub3JpZ2luYWxUZXh0ID0gb2JqLnRleHQ7XG4gICAgICAgICAgICAgICAgb2JqLnRleHQgPSBvYmoudGV4dC5zdWJzdHJpbmcoMCwgY2VsbFdpZHRoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGFsaWduID09PSAnQ0VOVEVSJykge1xuICAgICAgICAgICAgICAgIGxldCBzcGFjZXMgPSAoY2VsbFdpZHRoIC0gdGV4dExlbmd0aCkgLyAyO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IHMgPSAwOyBzIDwgc3BhY2VzOyBzKyspIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPSAnICc7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKG9iai50ZXh0ICE9PSAnJykge1xuICAgICAgICAgICAgICAgICAgICBpZiAob2JqLnN0eWxlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lU3RyICs9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGVzKG9iai5zdHlsZSkgKyBvYmoudGV4dCArIHN0eWxlcygnTk9STUFMJyk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsaW5lU3RyICs9IG9iai50ZXh0O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBzcGFjZXMgLSAxOyBzKyspIHtcbiAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPSAnICc7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChhbGlnbiA9PT0gJ1JJR0hUJykge1xuICAgICAgICAgICAgICAgIGxldCBzcGFjZXMgPSBjZWxsV2lkdGggLSB0ZXh0TGVuZ3RoO1xuICAgICAgICAgICAgICAgIGlmIChsZWZ0b3ZlclNwYWNlID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBzcGFjZXMgKz0gbGVmdG92ZXJTcGFjZTtcbiAgICAgICAgICAgICAgICAgICAgbGVmdG92ZXJTcGFjZSA9IDA7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBzcGFjZXM7IHMrKykge1xuICAgICAgICAgICAgICAgICAgICBsaW5lU3RyICs9ICcgJztcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAob2JqLnRleHQgIT09ICcnKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChvYmouc3R5bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVTdHIgKz1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHlsZXMob2JqLnN0eWxlKSArIG9iai50ZXh0ICsgc3R5bGVzKCdOT1JNQUwnKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVTdHIgKz0gb2JqLnRleHQ7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChvYmoudGV4dCAhPT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG9iai5zdHlsZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlcyhvYmouc3R5bGUpICsgb2JqLnRleHQgKyBzdHlsZXMoJ05PUk1BTCcpO1xuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGluZVN0ciArPSBvYmoudGV4dDtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGxldCBzcGFjZXMgPSBNYXRoLmZsb29yKGNlbGxXaWR0aCAtIHRleHRMZW5ndGgpO1xuICAgICAgICAgICAgICAgIGlmIChsZWZ0b3ZlclNwYWNlID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBzcGFjZXMgKz0gbGVmdG92ZXJTcGFjZTtcbiAgICAgICAgICAgICAgICAgICAgbGVmdG92ZXJTcGFjZSA9IDA7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgcyA9IDA7IHMgPCBzcGFjZXM7IHMrKykge1xuICAgICAgICAgICAgICAgICAgICBsaW5lU3RyICs9ICcgJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0b29Mb25nKSB7XG4gICAgICAgICAgICAgICAgc2Vjb25kTGluZUVuYWJsZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIG9iai50ZXh0ID0gb2JqLm9yaWdpbmFsVGV4dC5zdWJzdHJpbmcoY2VsbFdpZHRoKTtcbiAgICAgICAgICAgICAgICBzZWNvbmRMaW5lLnB1c2gob2JqKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgb2JqLnRleHQgPSAnJztcbiAgICAgICAgICAgICAgICBzZWNvbmRMaW5lLnB1c2gob2JqKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNldCBzaXplIHRvIGxpbmVcbiAgICAgICAgaWYgKHdpZHRoID4gMSkge1xuICAgICAgICAgICAgbGluZVN0ciA9XG4gICAgICAgICAgICAgICAgXy5URVhUX0ZPUk1BVC5UWFRfQ1VTVE9NX1NJWkUod2lkdGgsIGhlaWdodCkgK1xuICAgICAgICAgICAgICAgIGxpbmVTdHIgK1xuICAgICAgICAgICAgICAgIF8uVEVYVF9GT1JNQVQuVFhUX05PUk1BTDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFdyaXRlIHRoZSBsaW5lXG4gICAgICAgIHRoaXMud3JpdGUoYCR7bGluZVN0cn1cXG5gKTtcbiAgICAgICAgaWYgKHNlY29uZExpbmVFbmFibGVkKSB7XG4gICAgICAgICAgICAvLyBXcml0ZXMgc2Vjb25kIGxpbmUgaWYgaGFzXG4gICAgICAgICAgICByZXR1cm4gdGhpcy53cml0ZUN1c3RvbVRhYmxlKHNlY29uZExpbmUsIG9wdGlvbnMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKG9wdGlvbnMuZmVlZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuZmVlZChvcHRpb25zLmZlZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuZHJhd0xpbmUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmRyYXdMaW5lKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNldEludmVyc2UoaW52ZXJzZTogYm9vbGVhbiA9IHRydWUpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgdGhpcy53cml0ZShHUyk7XG4gICAgICAgIHRoaXMud3JpdGUoJ0InKTtcbiAgICAgICAgdGhpcy53cml0ZShpbnZlcnNlID8gMSA6IDApO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNldFVuZGVybGluZSh2YWx1ZTogYm9vbGVhbiA9IHRydWUpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgdGhpcy53cml0ZShFU0MpO1xuICAgICAgICB0aGlzLndyaXRlKCctJyk7XG4gICAgICAgIHRoaXMud3JpdGUodmFsdWUgPyAxIDogMCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNldEp1c3RpZmljYXRpb24odmFsdWU6IHN0cmluZyA9ICdsZWZ0Jyk6IEVzY0J1aWxkZXIge1xuICAgICAgICBsZXQgYWxpZ25tZW50O1xuICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7XG4gICAgICAgICAgICBjYXNlICdjZW50ZXInOlxuICAgICAgICAgICAgICAgIGFsaWdubWVudCA9IDE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdyaWdodCc6XG4gICAgICAgICAgICAgICAgYWxpZ25tZW50ID0gMjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgYWxpZ25tZW50ID0gMDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICB0aGlzLndyaXRlKEVTQyk7XG4gICAgICAgIHRoaXMud3JpdGUoJ2EnKTtcbiAgICAgICAgdGhpcy53cml0ZShhbGlnbm1lbnQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHNldEJvbGQoYm9sZDogYm9vbGVhbiA9IHRydWUpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgdGhpcy53cml0ZShFU0MpO1xuICAgICAgICB0aGlzLndyaXRlKCdFJyk7XG4gICAgICAgIHRoaXMud3JpdGUoYm9sZCA/IDEgOiAwKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICByYXN0ZXIoaW1hZ2U6IEltYWdlLCBtb2RlOiBSYXN0ZXJNb2RlID0gUmFzdGVyTW9kZS5Ob3JtYWwpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgY29uc3QgaGVhZGVyID0gbmV3IFVpbnQ4QXJyYXkoW0dTLCAweDc2LCAweDMwLCBtb2RlXSk7XG4gICAgICAgIGNvbnN0IHJhc3RlciA9IGltYWdlLnRvUmFzdGVyKCk7XG4gICAgICAgIHRoaXMud3JpdGUoaGVhZGVyKTtcbiAgICAgICAgdGhpcy53cml0ZShyYXN0ZXIud2lkdGgsIDE2KTtcbiAgICAgICAgdGhpcy53cml0ZShyYXN0ZXIuaGVpZ2h0LCAxNik7XG4gICAgICAgIHRoaXMud3JpdGUocmFzdGVyLmRhdGEpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cblxuICAgIC8qKlxuICAgIEBwYXJhbSBtb2RlIDAsIDB4MzBcbiAgICAqL1xuICAgIHNldFNpemUoc2l6ZTogc3RyaW5nID0gJ25vcm1hbCcpOiBFc2NCdWlsZGVyIHtcbiAgICAgICAgdGhpcy53cml0ZShFU0MpO1xuICAgICAgICB0aGlzLndyaXRlKCchJyk7XG4gICAgICAgIHRoaXMud3JpdGUoc2l6ZSA9PT0gJ25vcm1hbCcgPyAwIDogMHgzMCk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB3cml0ZSh2YWx1ZTogc3RyaW5nIHwgVWludDhBcnJheSB8IG51bWJlciwgbnVtYmVyOiBudW1iZXIgPSA4KTogYW55IHtcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIGlmIChudW1iZXIgPT0gOCkgdGhpcy5idWZmZXIud3JpdGVVSW50OCh2YWx1ZSk7XG4gICAgICAgICAgICBpZiAobnVtYmVyID09IDE2KSB0aGlzLmJ1ZmZlci53cml0ZVVJbnQxNkxFKHZhbHVlKTtcbiAgICAgICAgICAgIGlmIChudW1iZXIgPT0gMzIpIHRoaXMuYnVmZmVyLndyaXRlVUludDMyTEUodmFsdWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyLndyaXRlKHRoaXMuZW5jb2Rlci5lbmNvZGUodmFsdWUpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuYnVmZmVyLndyaXRlKHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG59XG4iXX0=